<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL Shortener</title>
    <style>
      .delete-btn {
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }

      tr:hover .delete-btn {
        opacity: 1;
      }

      .actions-column {
        width: 90px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>URL Shortener</h1>
      <form action="/shortUrls" method="POST" class="my-4 form-inline">
        <label for="fullUrl" class="sr-only">URL</label>
        <input
          required
          class="form-control mr-2 col"
          type="url"
          placeholder="Enter URL"
          name="fullUrl"
          id="fullUrl"
        />
        <label for="customSuffix" class="sr-only">Custom short URL</label>
        <input name="customSuffix" id="customSuffix" class="form-control mr-2" placeholder="Short (optional)" />
        <button type="submit" class="btn btn-success">Shorten</button>
      </form>
      
      <% if (shortUrls.length === 0) { %>
        <p>No URLs have been shortened yet.</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col">
                  <input type="checkbox" id="selectAll" />
                </th>
                <th>URL</th>
                <th>Short link</th>
                <th>Alias</th>
                <th>Clicks</th>
                <th>Created At</th>
                <th class="actions-column text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% shortUrls.forEach(shortUrl => { %>
                <tr>
                  <td>
                    <input
                      type="checkbox"
                      class="url-select"
                      name="selected"
                      value="<%= shortUrl.short %>"
                    />
                  </td>
                  <td><%= shortUrl.full %></td>
                  <td><a href="/<%= shortUrl.short %>"><%= shortUrl.short %></a></td>
                  <td>
                    <% if (shortUrl.alias && shortUrl.alias.length) { %>
                      <a href="/<%= shortUrl.alias[0] %>"><%= shortUrl.alias.join(", ") %></a>
                    <% } else { %>
                      <span class="text-muted">â€”</span>
                    <% } %>
                  </td>
                  <td><%= shortUrl.clicks %></td>
                  <td><%= new Date(shortUrl.createdAt).toLocaleString() %></td>
                  <td class="text-right">
                    <form
                      action="/delete"
                      method="POST"
                      class="d-inline"
                      onsubmit="return confirm('Delete this URL?');"
                    >
                      <input type="hidden" name="short" value="<%= shortUrl.short %>" />
                      <button
                        type="submit"
                        class="btn btn-outline-danger btn-sm delete-btn"
                        title="Delete this URL"
                      >
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="mt-2" id="bulkDeleteContainer" style="display: none;">
          <button
            type="button"
            id="deleteSelected"
            class="btn btn-danger btn-sm"
          >
            Delete selected
          </button>
        </div>
      <% } %>
    </div>
    <script>
      (function () {
        var selectAll = document.getElementById('selectAll');
        var deleteSelectedBtn = document.getElementById('deleteSelected');
        var bulkContainer = document.getElementById('bulkDeleteContainer');

        function updateBulkVisibility() {
          var anyChecked = !!document.querySelector('.url-select:checked');
          if (bulkContainer) {
            bulkContainer.style.display = anyChecked ? 'block' : 'none';
          }
        }

        if (selectAll) {
          selectAll.addEventListener('change', function () {
            var checkboxes = document.querySelectorAll('.url-select');
            checkboxes.forEach(function (cb) {
              cb.checked = selectAll.checked;
            });
            updateBulkVisibility();
          });
        }

        var rowCheckboxes = document.querySelectorAll('.url-select');
        if (rowCheckboxes.length) {
          rowCheckboxes.forEach(function (cb) {
            cb.addEventListener('change', function () {
              // If any gets unchecked, also uncheck "select all"
              if (!cb.checked && selectAll) {
                selectAll.checked = false;
              }
              updateBulkVisibility();
            });
          });
        }

        if (deleteSelectedBtn) {
          deleteSelectedBtn.addEventListener('click', function () {
            var selected = Array.prototype.slice
              .call(document.querySelectorAll('.url-select:checked'))
              .map(function (cb) {
                return cb.value;
              });

            if (selected.length === 0) {
              alert('No URLs selected for deletion.');
              return;
            }

            if (!confirm(selected.length + ' URLs selected. Delete them all?')) {
              return;
            }
            
          });
        }
      })();
    </script>
  </body>
</html>
