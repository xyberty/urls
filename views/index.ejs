<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              border: "hsl(214.3 31.8% 91.4%)",
              input: "hsl(214.3 31.8% 91.4%)",
              ring: "hsl(221.2 83.2% 53.3%)",
              background: "hsl(0 0% 100%)",
              foreground: "hsl(222.2 84% 4.9%)",
              primary: {
                DEFAULT: "hsl(221.2 83.2% 53.3%)",
                foreground: "hsl(210 40% 98%)",
              },
              secondary: {
                DEFAULT: "hsl(210 40% 96.1%)",
                foreground: "hsl(222.2 47.4% 11.2%)",
              },
              destructive: {
                DEFAULT: "hsl(0 84.2% 60.2%)",
                foreground: "hsl(210 40% 98%)",
              },
              muted: {
                DEFAULT: "hsl(210 40% 96.1%)",
                foreground: "hsl(215.4 16.3% 46.9%)",
              },
              accent: {
                DEFAULT: "hsl(210 40% 96.1%)",
                foreground: "hsl(222.2 47.4% 11.2%)",
              },
              popover: {
                DEFAULT: "hsl(0 0% 100%)",
                foreground: "hsl(222.2 84% 4.9%)",
              },
              card: {
                DEFAULT: "hsl(0 0% 100%)",
                foreground: "hsl(222.2 84% 4.9%)",
              },
            },
            borderRadius: {
              lg: "0.5rem",
              md: "calc(0.5rem - 2px)",
              sm: "calc(0.5rem - 4px)",
            },
          },
        },
      };
    </script>
    <style>
      * {
        border-color: hsl(214.3 31.8% 91.4%);
      }
      body {
        background-color: hsl(0 0% 100%);
        color: hsl(222.2 84% 4.9%);
      }
      .delete-btn {
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }
      tr:hover .delete-btn {
        opacity: 1;
      }
      #dialog-overlay {
        backdrop-filter: blur(4px);
      }
      #dialog-content {
        animation: dialog-content-show 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes dialog-content-show {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      #export-dialog-content {
        animation: dialog-content-show 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body class="min-h-full bg-background antialiased">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <div class="mb-8">
        <h1 class="text-4xl font-bold tracking-tight mb-2">URL Shortener</h1>
        <p class="text-muted-foreground">Create and manage your shortened URLs</p>
      </div>

      <% if (owner) { %>
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm mb-6 p-4">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm font-medium">Owner token:</span>
                <span id="ownerTokenContainer" class="flex items-center gap-2">
                  <code id="ownerToken" contenteditable="true" class="px-2 py-1 bg-muted rounded-md text-sm font-mono cursor-text min-w-[200px] inline-block focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2" onblur="handleOwnerTokenChange(this)" onkeydown="handleOwnerTokenKeydown(event, this)"><%= owner %></code>
                  <span class="text-xs text-muted-foreground">(click to edit)</span>
                </span>
              </div>
              <p class="text-xs text-muted-foreground">Changing the token will reassign all your URLs to the new token.</p>
            </div>
            <div>
              <button
                type="button"
                id="copyLinkBtn"
                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3"
                onclick="copyDashboardLink()"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2"></path></svg>
                Copy dashboard link
              </button>
            </div>
          </div>
        </div>
      <% } %>

      <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 mb-6">
        <form action="/shortUrls" method="POST" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-8">
              <label for="fullUrl" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 mb-2 block">
                URL
              </label>
              <input
                required
                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                type="url"
                placeholder="https://example.com"
                name="fullUrl"
                id="fullUrl"
              />
            </div>
            <div class="md:col-span-3">
              <label for="customSuffix" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 mb-2 block">
                Custom alias (optional)
              </label>
              <input
                name="customSuffix"
                id="customSuffix"
                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                placeholder="my-alias"
              />
            </div>
            <div class="md:col-span-1 flex items-end">
              <button
                type="submit"
                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full"
              >
                Shorten
              </button>
            </div>
          </div>
        </form>
      </div>
      
      <% if (shortUrls.length === 0) { %>
        <div class="rounded-lg border border-dashed bg-muted/50 p-12 text-center">
          <p class="text-muted-foreground">No URLs have been shortened yet.</p>
        </div>
      <% } else { %>
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full caption-bottom text-sm">
              <thead class="[&_tr]:border-b">
                <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                  <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12">
                    <input
                      type="checkbox"
                      id="selectAll"
                      class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-ring focus:ring-offset-2"
                    />
                  </th>
                  <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">URL</th>
                  <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Short link</th>
                  <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Alias</th>
                  <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Clicks</th>
                  <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Created At</th>
                  <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground w-24">Actions</th>
                </tr>
              </thead>
              <tbody class="[&_tr:last-child]:border-0">
                <% shortUrls.forEach(shortUrl => { %>
                  <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                    <td class="p-4 align-middle">
                      <input
                        type="checkbox"
                        class="url-select h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-ring focus:ring-offset-2"
                        name="selected"
                        value="<%= shortUrl.short %>"
                      />
                    </td>
                    <td class="p-4 align-middle">
                      <div class="max-w-md truncate" title="<%= shortUrl.full %>">
                        <%= shortUrl.full %>
                      </div>
                    </td>
                    <td class="p-4 align-middle">
                      <a
                        href="/<%= shortUrl.short %>"
                        class="text-primary hover:underline font-mono"
                        target="_blank"
                      >
                        <%= shortUrl.short %>
                      </a>
                    </td>
                    <td class="p-4 align-middle">
                      <% if (shortUrl.alias && shortUrl.alias.length) { %>
                        <a
                          href="/<%= shortUrl.alias[0] %>"
                          class="text-primary hover:underline font-mono"
                          target="_blank"
                        >
                          <%= shortUrl.alias.join(", ") %>
                        </a>
                      <% } else { %>
                        <span class="text-muted-foreground">—</span>
                      <% } %>
                    </td>
                    <td class="p-4 align-middle">
                      <span class="inline-flex items-center rounded-full bg-muted px-2.5 py-0.5 text-xs font-semibold">
                        <%= shortUrl.clicks %>
                      </span>
                    </td>
                    <td class="p-4 align-middle text-muted-foreground">
                      <%= new Date(shortUrl.createdAt).toLocaleString() %>
                    </td>
                    <td class="p-4 align-middle text-right">
                      <form
                        action="/delete"
                        method="POST"
                        class="inline delete-form"
                        data-short="<%= shortUrl.short %>"
                      >
                        <input type="hidden" name="short" value="<%= shortUrl.short %>" />
                        <button
                          type="button"
                          class="delete-btn inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-8 px-3"
                          title="Delete this URL"
                          onclick="handleDeleteClick(this)"
                        >
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
          <div id="bulkDeleteContainer" style="display: none;">
            <button
              type="button"
              id="deleteSelected"
              class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-9 px-4"
            >
              Delete selected
            </button>
          </div>
          <button
            type="button"
            id="exportBtn"
            class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4"
            onclick="exportUrls()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
            Export my URLs (JSON)
          </button>
        </div>
        <% } %>
    </div>

    <!-- Dialog Component -->
    <div id="dialog-overlay" class="fixed inset-0 z-50 bg-black/50 hidden items-center justify-center" onclick="closeDialog()">
      <div id="dialog-content" class="relative bg-card text-card-foreground rounded-lg border shadow-lg max-w-lg w-full mx-4 p-6" onclick="event.stopPropagation()">
        <div id="dialog-header" class="flex flex-col space-y-1.5 text-center sm:text-left mb-4">
          <h2 id="dialog-title" class="text-lg font-semibold leading-none tracking-tight"></h2>
          <p id="dialog-description" class="text-sm text-muted-foreground whitespace-pre-wrap"></p>
        </div>
        <div id="dialog-body" class="mb-4"></div>
        <div id="dialog-footer" class="flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 space-y-2 space-y-reverse sm:space-y-0">
          <button
            id="dialog-cancel"
            type="button"
            class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2"
          >
            Cancel
          </button>
          <button
            id="dialog-confirm"
            type="button"
            class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Export Dialog Component -->
    <div id="export-dialog-overlay" class="fixed inset-0 z-50 bg-black/50 hidden items-center justify-center" onclick="closeExportDialog()">
      <div id="export-dialog-content" class="relative bg-card text-card-foreground rounded-lg border shadow-lg max-w-2xl w-full mx-4 p-6 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-semibold leading-none tracking-tight">Export URLs</h2>
            <p id="export-stats" class="text-sm text-muted-foreground mt-1"></p>
          </div>
          <button
            type="button"
            onclick="closeExportDialog()"
            class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-8 w-8 rounded-md"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span class="sr-only">Close</span>
          </button>
        </div>
        <div id="export-body" class="flex-1 overflow-hidden flex flex-col">
          <div id="export-loading" class="flex items-center justify-center py-12">
            <div class="text-center">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
              <p class="text-sm text-muted-foreground">Loading export data...</p>
            </div>
          </div>
          <div id="export-content" class="hidden flex-1 flex flex-col">
            <div class="mb-4 flex-1 min-h-0">
              <label class="text-sm font-medium mb-2 block">JSON Preview</label>
              <textarea
                id="export-json"
                readonly
                class="flex min-h-[200px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none overflow-auto"
              ></textarea>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
              <button
                type="button"
                id="export-copy-btn"
                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2"
                onclick="copyExportToClipboard()"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2"></path></svg>
                Copy to clipboard
              </button>
              <button
                type="button"
                id="export-download-btn"
                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
                onclick="downloadExport()"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
                Download JSON
              </button>
            </div>
          </div>
          <div id="export-error" class="hidden">
            <div class="rounded-md bg-destructive/10 border border-destructive/20 p-4">
              <p class="text-sm text-destructive font-medium mb-1">Export failed</p>
              <p id="export-error-message" class="text-sm text-destructive/80"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Dialog system
      var dialogOverlay = document.getElementById('dialog-overlay');
      var dialogContent = document.getElementById('dialog-content');
      var dialogTitle = document.getElementById('dialog-title');
      var dialogDescription = document.getElementById('dialog-description');
      var dialogConfirm = document.getElementById('dialog-confirm');
      var dialogCancel = document.getElementById('dialog-cancel');
      var dialogCallback = null;

      function showDialog(options) {
        dialogTitle.textContent = options.title || 'Confirm';
        dialogDescription.textContent = options.description || '';
        dialogConfirm.textContent = options.confirmText || 'Confirm';
        dialogCancel.textContent = options.cancelText || 'Cancel';
        
        // Clear and set body content if provided
        var dialogBody = document.getElementById('dialog-body');
        if (options.body) {
          dialogBody.innerHTML = options.body;
          dialogBody.style.display = 'block';
        } else {
          dialogBody.innerHTML = '';
          dialogBody.style.display = 'none';
        }
        
        // Set button styles based on variant
        if (options.variant === 'destructive') {
          dialogConfirm.className = 'inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-10 px-4 py-2';
        } else {
          dialogConfirm.className = 'inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2';
        }
        
        dialogCallback = options.onConfirm || null;
        var cancelCallback = options.onCancel || null;
        
        // Remove old event listeners by cloning buttons
        var newConfirmBtn = dialogConfirm.cloneNode(true);
        var newCancelBtn = dialogCancel.cloneNode(true);
        dialogConfirm.parentNode.replaceChild(newConfirmBtn, dialogConfirm);
        dialogCancel.parentNode.replaceChild(newCancelBtn, dialogCancel);
        dialogConfirm = newConfirmBtn;
        dialogCancel = newCancelBtn;
        
        dialogConfirm.addEventListener('click', function() {
          if (dialogCallback) {
            dialogCallback();
          }
          closeDialog();
        });
        
        dialogCancel.addEventListener('click', function() {
          if (cancelCallback) {
            cancelCallback();
          }
          closeDialog();
        });
        
        dialogOverlay.classList.remove('hidden');
        dialogOverlay.classList.add('flex');
        document.body.style.overflow = 'hidden';
        
        // Animate in
        setTimeout(function() {
          dialogOverlay.style.opacity = '0';
          dialogContent.style.transform = 'scale(0.95)';
          dialogContent.style.opacity = '0';
          setTimeout(function() {
            dialogOverlay.style.transition = 'opacity 0.2s';
            dialogContent.style.transition = 'transform 0.2s, opacity 0.2s';
            dialogOverlay.style.opacity = '1';
            dialogContent.style.transform = 'scale(1)';
            dialogContent.style.opacity = '1';
          }, 10);
        }, 10);
      }

      function closeDialog() {
        dialogOverlay.style.transition = 'opacity 0.2s';
        dialogContent.style.transition = 'transform 0.2s, opacity 0.2s';
        dialogOverlay.style.opacity = '0';
        dialogContent.style.transform = 'scale(0.95)';
        dialogContent.style.opacity = '0';
        
        setTimeout(function() {
          dialogOverlay.classList.add('hidden');
          dialogOverlay.classList.remove('flex');
          document.body.style.overflow = '';
          dialogCallback = null;
        }, 200);
      }

      // Close on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !dialogOverlay.classList.contains('hidden')) {
          closeDialog();
        }
      });

      // Handle delete button clicks
      function handleDeleteClick(button) {
        var form = button.closest('form');
        var short = form.dataset.short || form.querySelector('input[name="short"]').value;
        var fullUrl = form.closest('tr').querySelector('td:nth-child(2)').textContent.trim();
        
        showDialog({
          title: 'Delete URL',
          description: 'Are you sure you want to delete this URL? This action cannot be undone.\n\n' + fullUrl,
          confirmText: 'Delete',
          cancelText: 'Cancel',
          variant: 'destructive',
          onConfirm: function() {
            form.submit();
          }
        });
      }
    </script>
    <script>
      (function () {
        var selectAll = document.getElementById('selectAll');
        var deleteSelectedBtn = document.getElementById('deleteSelected');
        var bulkContainer = document.getElementById('bulkDeleteContainer');

        function updateBulkVisibility() {
          var anyChecked = !!document.querySelector('.url-select:checked');
          if (bulkContainer) {
            bulkContainer.style.display = anyChecked ? 'block' : 'none';
          }
        }

        if (selectAll) {
          selectAll.addEventListener('change', function () {
            var checkboxes = document.querySelectorAll('.url-select');
            checkboxes.forEach(function (cb) {
              cb.checked = selectAll.checked;
            });
            updateBulkVisibility();
          });
        }

        var rowCheckboxes = document.querySelectorAll('.url-select');
        if (rowCheckboxes.length) {
          rowCheckboxes.forEach(function (cb) {
            cb.addEventListener('change', function () {
              // If any gets unchecked, also uncheck "select all"
              if (!cb.checked && selectAll) {
                selectAll.checked = false;
              }
              updateBulkVisibility();
            });
          });
        }

        if (deleteSelectedBtn) {
          deleteSelectedBtn.addEventListener('click', function () {
            var selected = Array.prototype.slice
              .call(document.querySelectorAll('.url-select:checked'))
              .map(function (cb) {
                return cb.value;
              });

            if (selected.length === 0) {
              showDialog({
                title: 'No URLs selected',
                description: 'Please select at least one URL to delete.',
                confirmText: 'OK',
                variant: 'default',
                onConfirm: function() {}
              });
              return;
            }

            showDialog({
              title: 'Delete URLs',
              description: selected.length + ' URL' + (selected.length > 1 ? 's' : '') + ' selected. Are you sure you want to delete ' + (selected.length > 1 ? 'them' : 'it') + '? This action cannot be undone.',
              confirmText: 'Delete',
              cancelText: 'Cancel',
              variant: 'destructive',
              onConfirm: function() {
                // Create a form and submit it
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '/delete';
                
                selected.forEach(function(value) {
                  var input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = 'selected';
                  input.value = value;
                  form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
              }
            });
          });
        }
      })();

      function copyDashboardLink() {
        var fullUrl = window.location.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(fullUrl).then(function() {
            var btn = document.getElementById('copyLinkBtn');
            var originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>Copied!';
            btn.classList.remove('border-input', 'bg-background', 'hover:bg-accent');
            btn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
            setTimeout(function() {
              btn.innerHTML = originalHTML;
              btn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
              btn.classList.add('border-input', 'bg-background', 'hover:bg-accent');
            }, 2000);
          }).catch(function(err) {
            console.error('Failed to copy:', err);
            fallbackCopy(fullUrl);
          });
        } else {
          fallbackCopy(fullUrl);
        }
      }

      function fallbackCopy(text) {
        var textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          var btn = document.getElementById('copyLinkBtn');
          var originalHTML = btn.innerHTML;
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>Copied!';
          btn.classList.remove('border-input', 'bg-background', 'hover:bg-accent');
          btn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
          setTimeout(function() {
            btn.innerHTML = originalHTML;
            btn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
            btn.classList.add('border-input', 'bg-background', 'hover:bg-accent');
          }, 2000);
        } catch (err) {
          alert('Failed to copy. Please copy the URL manually: ' + text);
        }
        document.body.removeChild(textArea);
      }

      var currentOwnerToken = '<%= owner || "" %>';

      function handleOwnerTokenKeydown(event, element) {
        if (event.key === 'Enter') {
          event.preventDefault();
          element.blur();
        } else if (event.key === 'Escape') {
          event.preventDefault();
          element.textContent = currentOwnerToken;
          element.blur();
        }
      }

      function handleOwnerTokenChange(element) {
        // Get text content - contenteditable can include HTML, so we need to extract just text
        var newToken = '';
        if (element.textContent !== undefined) {
          newToken = element.textContent.trim();
        } else if (element.innerText !== undefined) {
          newToken = element.innerText.trim();
        } else {
          newToken = element.textContent.trim();
        }
        
        // Remove any non-printable characters
        newToken = newToken.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
        
        var oldToken = currentOwnerToken;
        
        console.log('Changing owner token:', { 
          oldToken: oldToken, 
          newToken: newToken, 
          length: newToken.length,
          charCodes: newToken.split('').map(function(c) { return c.charCodeAt(0); })
        });
        
        // Validate token format: URL-safe characters, 1-128 chars
        if (!newToken || newToken.length < 1 || newToken.length > 128) {
          alert('Invalid owner token format. Token must be 1-128 characters long. Current length: ' + newToken.length);
          element.textContent = oldToken;
          return;
        }
        
        // Allow URL-safe characters: alphanumeric, dash, underscore, dot, tilde, at sign
        if (!/^[a-zA-Z0-9._~@-]+$/.test(newToken)) {
          var invalidChars = newToken.split('').filter(function(c) {
            return !/^[a-zA-Z0-9._~@-]$/.test(c);
          });
          alert('Invalid owner token format. Use only URL-safe characters (letters, numbers, dash, underscore, dot, tilde, at). Invalid characters found: ' + JSON.stringify(invalidChars));
          element.textContent = oldToken;
          return;
        }

        if (newToken === oldToken) {
          return; // No change
        }

        // Show loading state
        element.style.opacity = '0.5';
        element.contentEditable = 'false';

        // Call API to change owner
        fetch('/change-owner', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ newOwner: newToken })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              throw new Error(err.error || 'Failed to change owner token');
            });
          }
          return response.json();
        })
        .then(function(data) {
          if (data.success) {
            // Update URL with new owner token
            var url = new URL(window.location.href);
            url.searchParams.set('owner', newToken);
            window.location.href = url.toString();
          } else {
            throw new Error(data.error || 'Failed to change owner token');
          }
        })
        .catch(function(error) {
          console.error('Error changing owner:', error);
          alert('Failed to change owner token: ' + (error.message || error));
          element.textContent = oldToken;
          element.style.opacity = '1';
          element.contentEditable = 'true';
        });
      }

      // Export dialog system
      var exportData = null;
      var exportOwner = null;

      function exportUrls() {
        exportOwner = currentOwnerToken;
        showExportDialog();
        
        // Fetch the export data
        fetch('/export?owner=' + encodeURIComponent(exportOwner))
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Export failed: ' + response.statusText);
            }
            return response.json();
          })
          .then(function(data) {
            exportData = data;
            displayExportData(data);
          })
          .catch(function(error) {
            console.error('Export error:', error);
            showExportError(error.message);
          });
      }

      function showExportDialog() {
        var overlay = document.getElementById('export-dialog-overlay');
        var content = document.getElementById('export-dialog-content');
        var loading = document.getElementById('export-loading');
        var exportContent = document.getElementById('export-content');
        var exportError = document.getElementById('export-error');
        
        // Reset state
        loading.classList.remove('hidden');
        exportContent.classList.add('hidden');
        exportError.classList.add('hidden');
        exportData = null;
        
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        document.body.style.overflow = 'hidden';
        
        // Animate in
        setTimeout(function() {
          overlay.style.opacity = '0';
          content.style.transform = 'scale(0.95)';
          content.style.opacity = '0';
          setTimeout(function() {
            overlay.style.transition = 'opacity 0.2s';
            content.style.transition = 'transform 0.2s, opacity 0.2s';
            overlay.style.opacity = '1';
            content.style.transform = 'scale(1)';
            content.style.opacity = '1';
          }, 10);
        }, 10);
      }

      function closeExportDialog() {
        var overlay = document.getElementById('export-dialog-overlay');
        var content = document.getElementById('export-dialog-content');
        
        overlay.style.transition = 'opacity 0.2s';
        content.style.transition = 'transform 0.2s, opacity 0.2s';
        overlay.style.opacity = '0';
        content.style.transform = 'scale(0.95)';
        content.style.opacity = '0';
        
        setTimeout(function() {
          overlay.classList.add('hidden');
          overlay.classList.remove('flex');
          document.body.style.overflow = '';
          exportData = null;
        }, 200);
      }

      function displayExportData(data) {
        var loading = document.getElementById('export-loading');
        var exportContent = document.getElementById('export-content');
        var exportJson = document.getElementById('export-json');
        var exportStats = document.getElementById('export-stats');
        
        var jsonString = JSON.stringify(data, null, 2);
        exportJson.value = jsonString;
        
        var urlCount = Array.isArray(data) ? data.length : 0;
        var totalClicks = Array.isArray(data) ? data.reduce(function(sum, url) {
          return sum + (url.clicks || 0);
        }, 0) : 0;
        
        exportStats.textContent = urlCount + ' URL' + (urlCount !== 1 ? 's' : '') + ' • ' + totalClicks + ' total click' + (totalClicks !== 1 ? 's' : '');
        
        loading.classList.add('hidden');
        exportContent.classList.remove('hidden');
      }

      function showExportError(message) {
        var loading = document.getElementById('export-loading');
        var exportContent = document.getElementById('export-content');
        var exportError = document.getElementById('export-error');
        var errorMessage = document.getElementById('export-error-message');
        
        errorMessage.textContent = message;
        loading.classList.add('hidden');
        exportContent.classList.add('hidden');
        exportError.classList.remove('hidden');
      }

      function copyExportToClipboard() {
        if (!exportData) return;
        
        var jsonString = JSON.stringify(exportData, null, 2);
        var copyBtn = document.getElementById('export-copy-btn');
        var originalHTML = copyBtn.innerHTML;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(jsonString).then(function() {
            copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>Copied!';
            copyBtn.classList.remove('border-input', 'bg-background', 'hover:bg-accent');
            copyBtn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
            
            setTimeout(function() {
              copyBtn.innerHTML = originalHTML;
              copyBtn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
              copyBtn.classList.add('border-input', 'bg-background', 'hover:bg-accent');
            }, 2000);
          }).catch(function(err) {
            console.error('Failed to copy:', err);
            fallbackCopy(jsonString);
          });
        } else {
          fallbackCopy(jsonString);
        }
      }

      function downloadExport() {
        if (!exportData || !exportOwner) return;
        
        var jsonString = JSON.stringify(exportData, null, 2);
        var blob = new Blob([jsonString], { type: 'application/json' });
        var url = window.URL.createObjectURL(blob);
        
        var a = document.createElement('a');
        a.href = url;
        a.download = 'urls-' + exportOwner + '.json';
        document.body.appendChild(a);
        a.click();
        
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Show feedback
        var downloadBtn = document.getElementById('export-download-btn');
        var originalHTML = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>Downloaded!';
        
        setTimeout(function() {
          downloadBtn.innerHTML = originalHTML;
        }, 2000);
      }

      function fallbackCopy(text) {
        var textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          var copyBtn = document.getElementById('export-copy-btn');
          var originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>Copied!';
          copyBtn.classList.remove('border-input', 'bg-background', 'hover:bg-accent');
          copyBtn.classList.add('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
          setTimeout(function() {
            copyBtn.innerHTML = originalHTML;
            copyBtn.classList.remove('bg-primary', 'text-primary-foreground', 'hover:bg-primary/90', 'border-primary');
            copyBtn.classList.add('border-input', 'bg-background', 'hover:bg-accent');
          }, 2000);
        } catch (err) {
          alert('Failed to copy. Please select and copy manually.');
        }
        document.body.removeChild(textArea);
      }

      // Close export dialog on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          var exportOverlay = document.getElementById('export-dialog-overlay');
          if (!exportOverlay.classList.contains('hidden')) {
            closeExportDialog();
          }
        }
      });
    </script>
  </body>
</html>
